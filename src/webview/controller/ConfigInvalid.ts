import * as vscode from 'vscode';
import { Disposable, Webview, WebviewPanel, window, Uri, ViewColumn } from "vscode";
import { getUri } from "../../utilities/getUri";
import { getNonce } from "../../utilities/getNonce";
import { DirTool } from '../../utilities/DirTool';
import { LBRTools } from '../../utilities/LBRTools';
import { Constants } from '../../Constants';

/*
https://medium.com/@andy.neale/nunjucks-a-javascript-template-engine-7731d23eb8cc
https://mozilla.github.io/nunjucks/api.html
https://www.11ty.dev/docs/languages/nunjucks/
*/
const nunjucks = require('nunjucks');




export class ConfigInvalid implements vscode.WebviewViewProvider {


	public static readonly viewType = 'lbr-config-invalid';

	private _view?: vscode.WebviewView;
  private _context?: vscode.WebviewViewResolveContext;
  private readonly _extensionUri: vscode.Uri;


	constructor(extensionUri: vscode.Uri) {
    this._extensionUri = extensionUri;
   }



	public resolveWebviewView(
		webviewView: vscode.WebviewView,
		context: vscode.WebviewViewResolveContext,
		_token: vscode.CancellationToken,
	) {
		this._view = webviewView;
		this._context = context;

		webviewView.webview.options = {
			// Allow scripts in the webview
			enableScripts: true,
      enableCommandUris: true,
			localResourceRoots: [
        vscode.Uri.joinPath(this._extensionUri, "out"),
        vscode.Uri.joinPath(this._extensionUri, "asserts")
			]
		};

    if (vscode.workspace.workspaceFolders == undefined) {
      vscode.window.showErrorMessage('No workspace defined');
      return;
    }

    const html_template = 'controller/config_invalid.html';

    nunjucks.configure(Constants.HTML_TEMPLATE_DIR);
    const html = nunjucks.render(html_template,
      {
        global_stuff: LBRTools.get_global_stuff(webviewView.webview, this._extensionUri),
				main_java_script: getUri(webviewView.webview, this._extensionUri, ["out", "config_invalid.js"])
      }
    );
		webviewView.webview.html = html;

		webviewView.webview.onDidReceiveMessage(data => {
			switch (data.command) {
				case 'initialize_folder':
					{
						LBRTools.initialize_folder();
						break;
					}
				case 'reload_workspace':
					{
						vscode.commands.executeCommand('workbench.action.reloadWindow');
						break;
					}
				case 'config':
					{
						vscode.commands.executeCommand('lbr.controller.config');
						break;
					}
			}
		});
	}



}
